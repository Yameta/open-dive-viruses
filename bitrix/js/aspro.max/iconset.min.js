void 0===window.JIconset&&(window.JIconset=function(rand,code,arConfig){this.rand=rand,this.code=code,this.config={},this.popup=!1,this.block=!1,this.form=!1,this.selectButton=!1,this.eventListners=[],"object"==typeof arConfig&&(this.config=arConfig,this.init())},window.JIconset.prototype={init:function(){var that=this;BX.ready((function(){(that.block=BX("iconset-"+that.rand))&&(that.block.iconset=that,(that.popup=that.block.closest(".bx-core-window"))&&(that.selectButton=that.popup.querySelector(".adm-btn-save[id=iconset_button--select]"),that.popup.querySelector(".iconset_item--selected")||that.disableSelectButton()),(that.form=that.block.querySelector(".iconset_form"))&&(that.formUrl=that.form.getAttribute("action")||location.href),that.bindEvents())}))},bindEvents:function(){var that=this;"function"!=typeof that.onDocClick&&that.block&&(that.onDocClick=function(e){e||(e=window.event);var target=e.target||e.srcElement,block;if(target.closest("#iconset-"+that.rand)){var buttonDelete=target.closest(".iconset_btn--delete");if(buttonDelete){var icon=buttonDelete.closest(".iconset_item");if(icon){var id=BX.data(buttonDelete.closest(".iconset_item"),"id"),value=BX.data(buttonDelete.closest(".iconset_item"),"value");that.deleteIcon(id,value,(function(bSuccess){bSuccess&&(BX.addClass(icon,"iconset_item--deleted"),setTimeout((function(){BX.remove(icon)}),490),that.popup&&(that.popup.querySelector(".iconset_item--selected")||that.disableSelectButton()))}))}}else{var item=target.closest(".iconset_item");if(item){var items=Array.prototype.slice.call(item.parentNode.children);for(var i in items)items[i]===item?BX.addClass(items[i],"iconset_item--selected"):BX.removeClass(items[i],"iconset_item--selected");that.enableSelectButton()}else{var buttonLoad,subtabs;if(target.closest(".iconset_btn--load"))that.form&&BX.fireEvent(that.form,"submit");else if(target.closest(".adm-detail-subtabs")){var addIconTab=that.block.querySelector(".adm-detail-subtabs[id=view_tab_iconset_add_icon]");addIconTab&&(BX.hasClass(addIconTab,"adm-detail-subtab-active")?that.disableSelectButton():that.enableSelectButton())}}}}},document.addEventListener("click",that.onDocClick),that.form&&(that.onFormSubmit=function(e){e||(e=window.event),BX.PreventDefault(e);var errorMessage="",fd=new FormData;fd.set("code",that.code),fd.set("value",that.form.querySelector("input[name=value]").value),fd.set("action","add_icon");var fileInputs=Array.prototype.slice.call(that.form.querySelectorAll("input[name=iconset_new]")),fileInput=fileInputs.length?fileInputs[fileInputs.length-1]:null;if(fileInput){var bFile="file"===fileInput.getAttribute("type"),filename;if(bFile){var files=fileInput.files||[fileInput.value],filename=files.length?files[0].name||files[0]:"",p=Math.max(filename.lastIndexOf("/"),filename.lastIndexOf("\\"));p>0&&(filename=filename.substring(p+1,filename.length))}else var filename=fileInput.value;(filename=bFile?files.length?files[0].name:"":fileInput.value).length?that.config.validation_pattern&&null===filename.match(new RegExp(that.config.validation_pattern,"i"))&&(errorMessage=BX.message("ICONSET_ERROR_VALIDATION_FILE_BAD_NAME")):(errorMessage=BX.message("ICONSET_ERROR_VALIDATION_FILE_EMPTY_VALUE"),bFile||setTimeout((function(){that.resetFileInput()}),300)),errorMessage.length||fd.append(bFile?"icon_file":"icon_path",bFile?files[0]:fileInput.value)}errorMessage.length?that.showError(errorMessage):that.addIcon(fd,(function(id){id&&that.getIcon(id,(function(response){if(response){var child=BX.create({tag:"div",html:response});if(child=child.querySelector(".iconset_item")){that.openItemsTab();var wrap=that.block.querySelector(".iconset_wrap");if(wrap){wrap.scrollTop=0;var emptyItem=wrap.querySelector(".iconset_item--empty");emptyItem?BX.insertAfter(child,emptyItem):BX.prepend(child,wrap),setTimeout((function(){BX.removeClass(child,"iconset_item--added")}),1e3)}}else that.showError(BX.message("ICONSET_ERROR_REQUEST"))}}))}))}),that.form.addEventListener("submit",that.onFormSubmit))},unbindEvents:function(){"function"==typeof this.onDocClick&&document.removeEventListener("click",this.onDocClick),"function"==typeof this.onFormSubmit&&this.form&&this.form.removeEventListener("submit",this.onFormSubmit)},showError:function(errorMessage){var bForm,prependTo=this.block.querySelector(".adm-detail-subtab-active[id=view_tab_iconset_add_icon]")&&this.form?this.block.querySelector("div[id=iconset_add_icon]"):this.block.querySelector("div[id=iconset_items]"),error=BX.create({tag:"div",attrs:{class:"adm-info-message-wrap adm-info-message-red iconset_error"},style:{display:"none"},html:'<div class="adm-info-message"><div class="adm-info-message-title"></div><div class="adm-info-message-icon"></div></div>'});BX.prepend(error,prependTo.querySelector(".adm-detail-content-item-block-view-tab")),error&&(error.querySelector(".adm-info-message-title").textContent=errorMessage,error.style.display="block",BX.addClass(error,"iconset_error--visible"),setTimeout((function(){BX.removeClass(error,"iconset_error--visible"),setTimeout((function(){BX.remove(error)}),300)}),2300))},showLoader:function(){BX.addClass(this.form.closest(".iconset"),"iconset--sending")},hideLoader:function(){BX.removeClass(this.form.closest(".iconset"),"iconset--sending")},enableSelectButton:function(){this.selectButton&&this.selectButton.removeAttribute("disabled")},disableSelectButton:function(){this.selectButton&&this.selectButton.setAttribute("disabled","")},openItemsTab:function(){var tab=this.block.querySelector(".adm-detail-subtabs[id=view_tab_iconset_items]");tab&&BX.fireEvent(tab,"click")},openFormTab:function(){if(this.form){var tab=this.block.querySelector(".adm-detail-subtabs[id=view_tab_iconset_add_icon]");tab&&BX.fireEvent(tab,"click")}},resetFileInput:function(){if(this.form){var openers=Array.prototype.slice.call(this.form.querySelectorAll(".add-file-popup-btn")),opener=openers.length?openers[openers.length-1]:null;if(opener&&"object"==typeof opener.OPENER){var menu=opener.OPENER.GetMenu();if("object"==typeof menu&&menu.DIV){var menuItem=menu.DIV.querySelector(".adm-menu-delete")?menu.DIV.querySelector(".adm-menu-delete").parentNode:null;if(menuItem){menu.DIV.style.visibility="hidden",menu.Show();var interval=setInterval((function(){BX.fireEvent(menuItem,"click"),opener.closest(".iconset")||(menu.DIV.style.visibility="",clearInterval(interval))}),100)}}}}},addIcon:function(data,callback){if(this.form){var that=this;data instanceof FormData?data.set("action","add_icon"):data.action="add_icon",that.showLoader(),BX.ajax({url:that.formUrl,method:"POST",data:data,dataType:"html",processData:!1,preparePost:!1,emulateOnload:!1,start:!0,async:!0,cache:!1,onsuccess:function(response){errorMessage="";try{var result=JSON.parse(response);result.error.length?errorMessage=result.error:result.id||(errorMessage=BX.message("ICONSET_ERROR_REQUEST"))}catch(e){errorMessage=BX.message("ICONSET_ERROR_REQUEST")}that.resetFileInput(),that.hideLoader(),errorMessage.length?(that.showError(errorMessage),"function"==typeof callback&&callback(!1)):"function"==typeof callback&&callback(result.id)},onfailure:function(error){that.hideLoader(),that.showError(BX.message("ICONSET_ERROR_REQUEST")),"function"==typeof callback&&callback(!1)}})}else"function"==typeof callback&&callback(!1)},deleteIcon:function(id,value,callback){var that=this;if(confirm(BX.message("ICONSET_CONFIRM_DELETE"))){var iconset_values=Array.prototype.slice.call(document.querySelectorAll(".iconset_value"));if(iconset_values)for(var i in iconset_values){var input=iconset_values[i].querySelector("input");if(input&&input.value===value)return this.showError(BX.message("ICONSET_ERROR_DELETE_ICON_IS_SAVED_AS_OPTION_VALUE")),void("function"==typeof callback&&callback(!1))}that.showLoader(),BX.ajax({url:that.formUrl,method:"POST",data:{action:"delete_icon",code:that.code,id:id},dataType:"html",processData:!1,preparePost:!0,emulateOnload:!1,start:!0,async:!0,cache:!1,onsuccess:function(response){errorMessage="";try{var result=JSON.parse(response);result.error.length&&(errorMessage=result.error)}catch(e){errorMessage=BX.message("ICONSET_ERROR_REQUEST")}that.hideLoader(),errorMessage.length?(that.showError(errorMessage),"function"==typeof callback&&callback(!1)):"function"==typeof callback&&callback(!0)},onfailure:function(error){that.hideLoader(),that.showError(BX.message("ICONSET_ERROR_REQUEST")),"function"==typeof callback&&callback(!1)}})}},getIcon:function(id,callback){var that=this;that.showLoader(),BX.ajax({url:that.formUrl,method:"POST",data:{action:"get_icon",code:that.code,id:id},dataType:"html",processData:!1,preparePost:!0,emulateOnload:!1,start:!0,async:!0,cache:!1,onsuccess:function(response){that.hideLoader(),"function"==typeof callback&&callback(response)},onfailure:function(error){that.hideLoader(),that.showError(BX.message("ICONSET_ERROR_REQUEST")),"function"==typeof callback&&callback(!1)}})}},window.JIconset._onValueClick=function(e){e||(e=window.event),BX.PreventDefault(e);var icon=this;if(icon){if(BX.hasClass(icon,"iconset_value--readonly"))return!1;var code=BX.data(icon,"code"),input,value=icon.parentNode.querySelector("input").value,lang=BX.message("LANGUAGE_ID"),iconsetUrl="/bitrix/admin/aspro.max_iconset.php",iconsetDialog=new BX.CAdminDialog({content_url:iconsetUrl,content_post:{code:code,value:value,lang:lang},title:BX.message("ICONSET_POPUP_TITLE"),draggable:!0,resizable:!0,width:300,min_width:300,height:142,min_height:142,buttons:[{title:BX.message("ICONSET_POPUP_SELECT"),id:"iconset_button--select",name:"select",className:"adm-btn-save",action:function(){var selected=this.parentWindow.DIV.querySelector(".iconset_item--selected");if(selected){var value=BX.data(selected,"value"),content=selected.querySelector(".iconset_item_middle").innerHTML.trim();icon.querySelector(".iconset_value_wrap").innerHTML=content,icon.querySelector("input").value=value}this.parentWindow.Close()}},{title:BX.message("ICONSET_POPUP_CLOSE"),id:"iconset_button--cancel",name:"close",action:function(){this.parentWindow.Close()}}]});BX.addCustomEvent(iconsetDialog,"onWindowRegister",(function(){BX.WindowManager.Get().DIV.querySelector(".bx-core-adm-dialog-content").style.height=""})),BX.addCustomEvent(iconsetDialog,"onWindowClose",(function(){var iconset=BX.WindowManager.Get().DIV.querySelector(".iconset");iconset&&"object"==typeof iconset.iconset&&iconset.iconset&&iconset.iconset.unbindEvents()})),iconsetDialog.Show()}},BX.ready((function(){BX.bindDelegate(document.body,"click",{class:"iconset_value"},window.JIconset._onValueClick)})));